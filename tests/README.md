# Voice Performance Testing Tool

This folder contains a specialized test script for measuring voice assistant performance, specifically the time from upload completion to audio response reception.

## 📁 File Description

- `upload_to_response_time_test.py` - Specialized test script for measuring upload completion to audio response time
- `convert_audio.py` - Audio format conversion utility (M4A to PCM)
- `TestAudio.m4a` - Sample audio file for testing
- `TestAudio.pcm` - Converted PCM audio file (generated by convert_audio.py)

## 🚀 Quick Start

### 1. Install Dependencies

```bash
cd tests
pip install -r requirements.txt
```

### 2. Get Authentication Token

Login to your voice assistant application, open browser developer tools (F12), find any API request in the Network tab, and copy the Bearer token from the Authorization header.

### 3. Set Environment Variables

Create a `.env` file in the tests directory:
```bash
# Create .env file in tests directory
API_URL=http://localhost:8000
AUTH_TOKEN=
```

### 4. Prepare Audio File

If you have a `.m4a` audio file, convert it to PCM format:
```bash
python convert_audio.py
```

This will convert `TestAudio.m4a` to `TestAudio.pcm` in the required 16kHz, 16-bit, mono PCM format.

### 5. Run the Test

```bash
python upload_to_response_time_test.py
```

## 🎯 What This Test Measures

This specialized test precisely measures the **upload completion to audio response time**, which includes:

1. **Speech Recognition** - Converting uploaded audio to text
2. **AI Processing** - Generating response using Gemini
3. **Text-to-Speech Synthesis** - Converting response text to audio

**Timing Points:**
- **Start**: Moment when audio upload to server completes
- **End**: Moment when audio response data is received

## 📊 Test Output

### Successful Test Example
```
🎯 Specialized Test: Upload completion to audio response time
==================================================
Using User ID: f3e7d943-d722-4c80-b1ef-00d36755047e
Loaded audio file: 167936 bytes
🎯 Test Target: Measure upload completion to audio response time

=== Establishing connection and getting session_id ===
✅ Got session_id: voice_session_123456

=== Starting precise timing test ===
📤 Uploading audio...
✅ Audio upload complete, timing started!
📤 Upload confirmation: message

🔍 Waiting for audio response...
📝 Text response (3.45s): Hello! I heard you say "Hi, nice to meet you..."
🎵 Audio response received!
⏱️  Processing time: 8.73s
📊 Audio size: 2560 bytes

=== Test Results ===
📁 Audio file: TestAudio.pcm (167936 bytes)
🎯 Upload completion to audio response time: 8.73s
✅ Test successful!
📊 Estimated audio playback duration: 0.08s
📊 Total user experience time: 8.81s
```

## 🔧 Configuration

### API_URL
- Local development: `http://localhost:8000`

### AUTH_TOKEN
JWT token from browser developer tools, format:
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```
Copy only the token part (after "Bearer ").

### User ID Extraction
The script automatically extracts the user ID from the JWT token, so you don't need to set it manually.

## 🛠️ Troubleshooting

### Common Errors

1. **Authentication Failed (401)**
   - Check if AUTH_TOKEN is correct
   - Verify token hasn't expired
   - Ensure token format is correct (no "Bearer " prefix in .env)

2. **PCM File Not Found**
   - Run `python convert_audio.py` to convert M4A to PCM
   - Ensure `TestAudio.m4a` exists in the tests directory

3. **Connection Timeout**
   - Check if API_URL is correct
   - Verify backend service is running
   - Check if backend is accessible from your network

4. **Backend Service Not Running**
   ```bash
   # Start backend service
   cd backend
   python main.py
   ```

### Debug Steps

1. **Verify Backend Status**
   ```bash
   curl http://localhost:8000/health
   ```

2. **Check Environment Variables**
   ```bash
   cat .env
   ```

3. **Test Token Validity**
   - Decode JWT token to check expiration
   - Get fresh token from browser if needed

4. **Verify Audio File**
   ```bash
   ls -la TestAudio.*
   ```

## 📈 Performance Benchmarks

Based on testing with Edge TTS implementation:
- Audio file size: ~30-40% smaller than gTTS
- Better audio quality and multi-language support
- Improved transmission efficiency

**Typical Performance Metrics:**
- **Processing Time**: 8-15 seconds (depends on audio length and complexity)
- **Audio Response Size**: 2-5KB (varies by response length)
- **Total User Experience**: Processing time + ~0.05-0.15s playback


## 📋 Technical Details

### Audio Format Requirements
- **Input**: PCM format, 16kHz sample rate, 16-bit depth, mono channel
- **Conversion**: Use `convert_audio.py` for M4A → PCM conversion

### API Endpoints Used
- **SSE Connection**: `/api/voice-redis/events/{user_id}?is_audio=true`
- **Audio Upload**: `/api/voice-redis/send/{session_id}`

### Test Architecture
1. Establish SSE connection to get session_id
2. Upload audio data via POST request
3. Listen for events through SSE stream
4. Measure time from upload completion to audio response reception

This test provides precise performance metrics for the core voice processing pipeline, helping optimize user experience in voice interactions. 